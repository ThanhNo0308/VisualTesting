<!doctype html>
<html lang="vi">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Visual Testing</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>

<body>
  <div class="container">
    <h1>Hệ thống kiểm thử quảng cáo Website</h1>

    <section class="card">
      <h2>So sánh trực tiếp</h2>
      <div id="directComparisons">
        <div class="comparison-item">
          <div class="upload-section">
            <div class="upload-box">
              <label>Ảnh gốc</label>
              <input type="file" name="original" accept="image/*" required
                onchange="previewImage(this, this.parentNode.querySelector('.image-preview'))" />
              <div class="image-preview"></div>
            </div>
            <div class="upload-box">
              <label>Ảnh biến thể</label>
              <input type="file" name="variant" accept="image/*" required
                onchange="previewImage(this, this.parentNode.querySelector('.image-preview'))" />
              <div class="image-preview"></div>
            </div>
          </div>
          <div class="button-group">
            <button onclick="compareImages(this)" class="btn-compare">So sánh</button>
            <button onclick="removeComparison(this)" class="btnDel">Xóa</button>
          </div>
          <div class="result-section"></div>
        </div>
      </div>
      <button onclick="addComparison()" class="btnAdd">+ Thêm</button>
    </section>

    <section class="card">
      <h2>Kiểm thử tự động</h2>

      <div class="shared-original">
        <h3>Ảnh quảng cáo gốc</h3>
        <div class="upload-box">
          <input type="file" id="sharedOriginal" accept="image/*" required
            onchange="previewImage(this, document.getElementById('sharedPreview'))" />
          <div id="sharedPreview" class="image-preview"></div>
        </div>
      </div>

      <div id="crawlTests">
        <div class="crawl-item">
          <div class="crawl-inputs">
            <div class="row">
              <label>Tên chi nhánh:</label>
              <input type="text" name="branch" placeholder="Chi nhánh A, Website B..." />
            </div>
            <div class="row">
              <label>URL:</label>
              <input type="url" name="url" placeholder="https://example.com" required />
            </div>
            <div class="row">
              <label>CSS Selector:</label>
              <input type="text" name="selector" placeholder=".banner, #ad, img[alt='logo']" required />
            </div>
          </div>
          <div class="button-group">
            <button onclick="removeCrawlTest(this)" class="btnDel">Xóa</button>
          </div>
        </div>
      </div>
      <div class="control-buttons">
        <button onclick="addCrawlTest()" class="btnAdd">+ Thêm chi nhánh</button>
        <button onclick="runAllTests()" class="btn-run-all">Chạy tất cả</button>
      </div>
      <div id="allResults"></div>
      <div id="resultModal" class="modal" onclick="closeModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
          <span class="close" onclick="closeModal()">&times;</span>
          <div id="modalBody"></div>
        </div>
      </div>
    </section>
  </div>

  <script>
    function showModal(result) {
      const modal = document.getElementById('resultModal');
      const modalBody = document.getElementById('modalBody');

      const statusMap = {
        'similar': { text: 'Không vi phạm', color: '#22c55e' },
        'almost': { text: 'Cần kiểm chứng', color: '#f59e0b' },
        'different': { text: 'Vi phạm', color: '#ef4444' }
      };
      const status = statusMap[result.label] || statusMap['different'];

      modalBody.innerHTML = `
            <div class="modal-detail">
                <h3>${result.branch}</h3>
                <div class="status-badge" style="background-color: ${status.color};">
                    ${status.text}
                </div>
                <p><strong>URL:</strong> ${result.url}</p>
                
                ${result.downloaded_image ? `
                    <h4>Ảnh đã tải từ web:</h4>
                    <img src="${result.downloaded_image}" alt="Downloaded Image" />
                ` : ''}
              
            </div>
        `;

      modal.style.display = 'block';
    }

    function closeModal() {
      document.getElementById('resultModal').style.display = 'none';
    }


    function previewImage(input, preview) {
      const file = input.files[0];
      preview.innerHTML = file ? `<img src="${URL.createObjectURL(file)}" alt="Preview" />` : '';
    }

    function displayResult(label, downloadedImg = null, branchName = '') {
      const statusMap = {
        'similar': { text: 'Không vi phạm', class: 'status-safe', color: '#22c55e' },
        'almost': { text: 'Cần kiểm chứng', class: 'status-warning', color: '#f59e0b' },
        'different': { text: 'Vi phạm', class: 'status-danger', color: '#ef4444' }
      };
      const status = statusMap[label] || statusMap['different'];

      return `
            <div class="result-card ${status.class}">
                ${branchName ? `<h4>${branchName}</h4>` : ''}
                <div class="status-badge" style="background-color: ${status.color};">${status.text}</div>
            </div>
            ${downloadedImg ? `<div class="captured-preview"><h4>Ảnh đã tải từ web:</h4><img src="${downloadedImg}" alt="Downloaded" style="max-width: 300px; border-radius: 6px;" /></div>` : ''}
        `;
    }

    async function compareImages(button) {
      const item = button.closest('.comparison-item');
      const files = [item.querySelector('input[name="original"]').files[0], item.querySelector('input[name="variant"]').files[0]];
      const resultDiv = item.querySelector('.result-section');

      if (!files[0] || !files[1]) {
        resultDiv.innerHTML = '<div class="error">Vui lòng chọn đủ 2 ảnh</div>';
        return;
      }

      resultDiv.innerHTML = '<div class="loading">Đang xử lý...</div>';

      try {
        const fd = new FormData();
        fd.append('original', files[0]);
        fd.append('variant', files[1]);

        const res = await fetch('/predict', { method: 'POST', body: fd });
        const data = await res.json();

        resultDiv.innerHTML = data.error ? `<div class="error">Lỗi: ${data.error}</div>` : displayResult(data.label);
      } catch (error) {
        resultDiv.innerHTML = `<div class="error">Lỗi kết nối: ${error.message}</div>`;
      }
    }

    async function runAllTests() {
      const sharedOriginal = document.getElementById('sharedOriginal').files[0];
      const resultDiv = document.getElementById('allResults');

      if (!sharedOriginal) {
        resultDiv.innerHTML = '<div class="error">Vui lòng chọn ảnh gốc trước</div>';
        return;
      }

      const websites = Array.from(document.querySelectorAll('.crawl-item')).map(item => ({
        branch: item.querySelector('input[name="branch"]').value.trim() || 'Không tên',
        url: item.querySelector('input[name="url"]').value.trim(),
        selector: item.querySelector('input[name="selector"]').value.trim()
      })).filter(site => site.url && site.selector);

      if (!websites.length) {
        resultDiv.innerHTML = '<div class="error">Không có trang web nào để test</div>';
        return;
      }

      resultDiv.innerHTML = `<div class="loading">Đang test ${websites.length} trang web...</div>`;

      try {
        const fd = new FormData();
        fd.append('original', sharedOriginal);

        const res = await fetch('/crawl-all', {
          method: 'POST',
          body: fd,
          headers: { 'X-Websites': JSON.stringify(websites) }
        });

        const data = await res.json();

        if (data.error) {
          resultDiv.innerHTML = `<div class="error">Lỗi: ${data.error}</div>`;
          return;
        }

        const successful = data.results.filter(r => r.status === 'success');
        const summary = {
          safe: successful.filter(r => r.label === 'similar').length,
          warning: successful.filter(r => r.label === 'almost').length,
          danger: successful.filter(r => r.label === 'different').length,
          failed: data.results.filter(r => r.status === 'failed').length
        };

        let html = `
                <h3>Kết quả test tổng hợp (${data.results.length} chi nhánh):</h3>
                
                <div class="results-summary">
                    <div class="summary-item">
                        <div class="summary-number safe">${summary.safe}</div>
                        <div class="summary-label">Không vi phạm</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number warning">${summary.warning}</div>
                        <div class="summary-label">Cần kiểm chứng</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number danger">${summary.danger}</div>
                        <div class="summary-label">Vi phạm</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-number">${summary.failed}</div>
                        <div class="summary-label">Lỗi crawl</div>
                    </div>
                </div>
                
                <div class="results-grid">
            `;

        data.results.forEach(result => {
          if (result.status === 'success') {
            const statusMap = {
              'similar': { text: 'Không vi phạm', color: '#22c55e' },
              'almost': { text: 'Cần kiểm chứng', color: '#f59e0b' },
              'different': { text: 'Vi phạm', color: '#ef4444' }
            };
            const status = statusMap[result.label];

            html += `
                        <div class="result-item" onclick="showModal(${JSON.stringify(result).replace(/"/g, '&quot;')})">
                            <h4>${result.branch}</h4>
                            <div class="status-mini" style="background-color: ${status.color};">
                                ${status.text}
                            </div>
                            ${result.downloaded_image ? `
                                <img src="${result.downloaded_image}" alt="Preview" class="preview-img" />
                            ` : ''}
                            <div class="url-preview">${result.url}</div>
                        </div>
                    `;
          } else {
            html += `
                        <div class="result-item">
                            <h4>${result.branch}</h4>
                            <div class="status-mini" style="background-color: #6b7280;">
                                Lỗi crawl
                            </div>
                            <div class="error" style="margin: 8px 0; font-size: 12px;">
                                ${result.error}
                            </div>
                            <div class="url-preview">${result.url || 'N/A'}</div>
                        </div>
                    `;
          }
        });

        html += '</div>';
        resultDiv.innerHTML = html;

      } catch (error) {
        resultDiv.innerHTML = `<div class="error">Lỗi kết nối: ${error.message}</div>`;
      }
    }

    function addComparison() {
      const container = document.getElementById('directComparisons');
      const newItem = container.querySelector('.comparison-item').cloneNode(true);
      newItem.querySelectorAll('input').forEach(input => { input.value = ''; input.files = null; });
      newItem.querySelectorAll('.image-preview').forEach(preview => preview.innerHTML = '');
      newItem.querySelector('.result-section').innerHTML = '';
      container.appendChild(newItem);
    }

    function removeComparison(button) {
      const container = document.getElementById('directComparisons');
      if (container.children.length > 1) button.closest('.comparison-item').remove();
    }

    function addCrawlTest() {
      const container = document.getElementById('crawlTests');
      const newItem = container.querySelector('.crawl-item').cloneNode(true);
      newItem.querySelectorAll('input').forEach(input => input.value = '');
      container.appendChild(newItem);
    }

    function removeCrawlTest(button) {
      const container = document.getElementById('crawlTests');
      if (container.children.length > 1) button.closest('.crawl-item').remove();
    }
  </script>
</body>

</html>